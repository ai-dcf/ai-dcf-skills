# 阶段 4：提示词生成（Prompt Generation）

**目标：** 基于主题 + 风格 + 比例，生成优化的绘图提示词（Prompt）。

---

## 生成步骤

### 0. 自动检测模板类型（用户无感知）
- **自动识别内容类型**：分析用户主题中的关键词
  - 检测到人物相关内容 → 采用**人物信息图模板**
  - 普通主题 → 采用**通用信息图模板**
- **检测关键词包括**：角色、人物、人设、属性、性格、人际、装备、表情等
- **用户体验**：系统自动判断，用户不需要做任何选择

### 1. 提取主题关键信息
- 解析用户的主题，提取核心内容、层级、隐喻等
- 例如：营销漏斗 → 5 层 → 从广到窄的流程
- **人物信息图特例**：提取角色名、特征、关键信息等

### 2. 选定风格描述块
- 根据用户选择的风格，从 `references/styles.md` 中获取对应风格的绘图提示词
- 16种风格各有独特的视觉描述和氛围营造
- 直接使用该风格的标准绘图提示词作为风格基础
- 风格对人物信息图和通用信息图同样适用

### 3. 考虑比例对版式的影响
- **16:9（横版）**：横向空间充足，适合放置多个并列元素、流程图、对比内容
- **3:4（竖版中等）**：竖向较长，适合强调单一主题、分层内容、自上而下的流程
- **9:16（竖版长条）**：竖向拉长，内容应精简集中，强调核心信息点
- **1:1（方形）**：均衡布局，内容应居中对称，避免极端的纵向或横向设计

根据用户选择的比例，调整以下方面：
- 标题大小与位置
- 元素排列方向（横排 vs 竖排）
- 留白分布

### 4. 结构设计
- **标题（大字）**：主题
- **副标题（可选小字）**：如果主题太简短可加
- **主体**：根据内容和比例选择适合的版式
  - 流程型：箭头连接的步骤
  - 分类型：并列的卡片/圆圈
  - 对比型：左右（适合16:9）或上下（适合竖版）对比
- **底部结论**：一句关键结论或行动号召

### 5. 提示词约束
- **强制要求**：中文清晰可读、无乱码、大字号、少字短句
- **比例要求**：`aspect ratio [用户选择的比例]`
- **版式要求**：根据比例调整 → 留白充足、对齐清晰
- **风格约束**：详见风格模板中的"负面提示"

### 6. 输出完整提示词
- 一个独立的代码块，便于用户复制或脚本调用
- 代码块前 1-2 句说明

---

## 本阶段输出物

### Prompt Pack

```
{完整的、优化的绘图提示词，包含比例约束}
```

说明文字：
- "这是为你生成的'[主题]'[模板类型]提示词，采用[风格]风格、[比例]格式"
- 模板类型：`人物信息图` 或 `通用信息图`（自动判断，无需用户操作）
- 提示词已包含：风格要求、比例约束、版式设计、内容文字等

### 会话记录更新
- `template_type`: 记录本次使用的模板类型
  - `人物信息图`: 含中心肖像、情绪、档案、关系、装备5个区块
  - `通用信息图`: 含标题、主体内容、结论的标准信息图

---

## 智能内容分析

### 新增功能：智能信息量分析

系统在生成提示词时会自动分析用户输入的**复杂度**和**信息密度**，并据此调整：

1. **内容点数** - 自动确定需要多少个主要内容点
   - 简单主题 → 2-3 个点
   - 中等主题 → 3-4 个点
   - 复杂主题 → 5-6 个点

2. **内容深度** - 调整每个点的详细程度
   - 浅显 → 简短描述（1-2 句）
   - 中等 → 标准说明（1-2 句）
   - 深层 → 详细解释（2-3 句）

3. **结论部分** - 动态决定是否需要结论
   - 有明确关键点 → 需要结论（行动号召或洞察）
   - 内容复杂 → 需要结论（总结）
   - 内容简单 → 不需要结论

### 分析算法

**文本长度** → 主题描述的详细程度
- < 20 字：简洁主题，可能偏简单
- 20-80 字：正常主题
- > 80 字：详细主题，通常更复杂

**关键词分析**
- 复杂度关键词：系统、分析、框架、模型、策略 等
- 简单性关键词：基础、入门、简介 等
- 信息密度关键词：分类、包括、特点、类型 等

**内容类型**
- 流程型 → 通常需要多个阶段（4-6 个）
- 对比型 → 通常需要对等的项目（3-5 个）
- 列表型 → 灵活数量（2-8 个）
- 时间线 → 根据事件数量（3-6 个）

## 提示词模板参考

参考文件：
- 风格库：`references/styles.md`（包含所有16种风格的详细绘图提示词）
- 基础模板：`templates/base-prompt.md`（通用信息图基础模板 + 智能分析说明）
- 人物模板：`templates/character-prompt.md`（人物信息图专用模板结构参考）

### 模板选择算法

**自动检测逻辑：**
1. 组合分析：topic + audience + key_point 中的所有关键词
2. 关键词匹配：检查是否包含人物相关关键词
3. 判定条件：
   - 包含 3 个及以上人物相关关键词 → **人物信息图**
   - 包含高权重关键词（角色设定、人物设定、角色卡等）→ **人物信息图**
   - 否则 → **通用信息图**

**人物相关关键词库：**
- 角色类：角色、人物、人设、角色设定、设定、头像
- 属性类：属性、特征、特点、性格、个性、脾气
- 关系类：人际、关系、宿敌、对手、伙伴、搭档、羁绊
- 装备类：装备、物品、道具、武器、宝物
- 表情类：表情、情绪、心情、情感
- 档案类：档案、档案卡、名片、简历、通缉令、身份

---

## 比例约束在提示词中的表达

在完整提示词中，确保包含以下之一：

| 比例 | 提示词表达 |
|---|---|
| 16:9 | `aspect ratio 16:9 landscape` 或 `aspect ratio 16:9` |
| 3:4 | `aspect ratio 3:4 portrait` |
| 9:16 | `aspect ratio 9:16 tall portrait` 或 `aspect ratio 9:16` |
| 1:1 | `aspect ratio 1:1 square` |
